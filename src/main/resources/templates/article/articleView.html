<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{common/layout/default_layout}" lang="ko">

<!-- Content -->
<div layout:fragment="content">
  <h1 th:text="${article.title}"></h1>
  <p>작성자: <span th:text="${article.email}"></span></p>
  <p>조회수: <span th:text="${article.viewCount}"></span></p>
  <div>
    <h4>내용</h4>
    <p th:text="${article.content}"></p>
  </div>
  <div>
    <h4>태그</h4>
    <ul>
      <li th:each="tag : ${article.tags}" th:text="${tag}"></li>
    </ul>
  </div>

  <div>
    <h4>댓글</h4>
    <div sec:authorize="isAuthenticated()">
      <label for="commentContent"></label>
      <textarea id="commentContent" class="form-control" placeholder="댓글을 작성해주세요..."></textarea>
      <button class="btn btn-primary mt-2" id="submitComment">등록</button>
    </div>
    <div sec:authorize="!isAuthenticated()">
      <textarea readonly class="form-control" placeholder="로그인이 필요합니다"></textarea>
    </div>
  </div>

  <div class="comment-list mt-4">
    <h4>댓글 목록</h4>
    <div th:each="comment : ${article.comments}" class="comment-item">
      <p th:text="${comment.content}"></p>
      <small th:text="${#temporals.format(comment.createdDate, 'yyyy-MM-dd')}"></small>
      <button class="btn btn-link reply-btn" th:data-id="${comment.id}">대댓글</button>
      <div class="reply-form" style="display: none;">
        <label>
          <textarea class="form-control" placeholder="대댓글을 입력하세요..." data-parent-id="${comment.id}"></textarea>
        </label>
        <button class="btn btn-secondary submit-reply">등록</button>
      </div>
      <div th:each="childComment : ${comment.childComments}" class="child-comment">
        <p th:text="${childComment.content}"></p>
        <small th:text="${#temporals.format(childComment.createdDate, 'yyyy-MM-dd')}"></small>
      </div>
    </div>
  </div>

  <a th:href="@{/}" class="btn btn-secondary">목록으로 돌아가기</a>
  <th:block th:if="${isAdmin}">
    <a th:href="@{/article/edit(articleId=${article.id})}" class="btn btn-warning">수정</a>
  </th:block>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    const articleId = /*[[${article.id}]]*/ '0';

    document.getElementById('submitComment').addEventListener('click', function() {
      const commentContent = document.getElementById('commentContent').value.trim();

      if (commentContent === '') {
        alert('댓글 내용을 입력해주세요.');
        return;
      }

      fetch(`/comment`, {
        method: 'POST',
        body: JSON.stringify({
          articleId: articleId,
          content: commentContent,
          parentId: null
        }),
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'include'
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('댓글 작성 실패');
        }
        return response.json();
      })
      .then(data => {
        const commentList = document.querySelector('.comment-list');
        const newComment = document.createElement('div');
        newComment.className = 'comment-item';
        newComment.innerHTML = `
          <p>${data.content}</p>
          <small>${data.email}</small>
          <button class="btn btn-link reply-btn" data-id="${data.id}">대댓글</button>
          <div class="reply-form" style="display: none;">
            <label>
              <textarea class="form-control" placeholder="대댓글을 입력하세요..." data-parent-id="${data.id}"></textarea>
            </label>
            <button class="btn btn-secondary submit-reply">등록</button>
          </div>
        `;
        commentList.prepend(newComment);
        document.getElementById('commentContent').value = '';
      })
      .catch(error => console.error('Error:', error));
    });
  });
</script>
</html>

